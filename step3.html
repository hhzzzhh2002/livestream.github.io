<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venus Model with Mirrored Video Screenshot</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;800&display=swap');
        
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Montserrat', sans-serif;
        }
        #container {
            position: relative;
            width: 1080px;
            height: 1920px;
            background-color: #000;
        }
        video {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 360px;
            height: 640px;
            border: 2px solid rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            display: block;
            transform: scaleX(-1);
            object-fit: cover;
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        canvas {
            display: none;
        }
        #textOverlay {
            position: absolute;
            bottom: 200px;
            left: 0;
            width: 100%;
            color: white;
            font-size: 42px;
            text-align: center;
            z-index: 10;
            pointer-events: none;
            letter-spacing: 2px;
        }
        #textOverlay .title-container {
            position: relative;
            display: inline-block;
            margin-bottom: 15px;
        }
        #textOverlay .title {
            font-weight: 800;
            font-size: 56px;
            text-transform: uppercase;
            color: white;
            position: relative;
            z-index: 2;
            padding: 10px 30px;
            letter-spacing: 3px;
        }
        #textOverlay .title-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #FF6B6B, #FF8E53);
            z-index: 1;
            transform: skew(-5deg);
        }
        #textOverlay .price-container {
            position: relative;
            display: inline-block;
        }
        #textOverlay .price {
            font-weight: 600;
            font-size: 36px;
            color: white;
            position: relative;
            z-index: 2;
            padding: 8px 20px;
        }
        #textOverlay .price-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #4A00E0, #8E2DE2);
            z-index: 1;
            transform: skew(-5deg);
        }
        #posterContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
        }
        #posterImage {
            max-width: 80%;
            max-height: 80%;
            border: 3px solid white;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        .posterButton {
            margin-top: 20px;
            padding: 12px 25px;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 18px;
            margin-right: 15px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .posterButton:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
        #debugInfo {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-radius: 5px;
            z-index: 30;
            max-width: 400px;
            max-height: 150px;
            overflow-y: auto;
            opacity: 0.7;
        }
        #gesturePrompt {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 28px;
            background: linear-gradient(45deg, rgba(0,0,0,0.7), rgba(0,0,0,0.9));
            padding: 15px 30px;
            border-radius: 50px;
            z-index: 25;
            text-align: center;
            display: none;
            font-weight: 300;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        #gestureIcon {
            display: block;
            font-size: 40px;
            margin: 10px 0;
        }
        .watermark {
            position: absolute;
            bottom: 30px;
            right: 30px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 16px;
            font-weight: 300;
            letter-spacing: 2px;
            z-index: 5;
        }
        #manualCaptureBtn {
            position: absolute;
            bottom: 80px;
            right: 20px;
            padding: 10px 20px;
            background: linear-gradient(45deg, #ff4e50, #f9d423);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 30;
        }
        #manualCaptureBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
        #loadingIndicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loadingText {
            color: white;
            font-size: 18px;
            margin-top: 20px;
            font-family: 'Montserrat', sans-serif;
        }
        #backgroundImage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #backgroundUploadContainer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 30;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        #backgroundUpload {
            display: none;
        }
        .uploadLabel {
            padding: 8px 15px;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }
        .uploadLabel:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
        #backgroundStatus {
            color: white;
            font-size: 12px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-radius: 5px;
            margin-top: 5px;
            display: none;
        }
        #threeJsRenderer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
            pointer-events: none;
        }
        #modelControls {
            position: absolute;
            bottom: 150px;
            right: 20px;
            z-index: 30;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
        }
        .controlLabel {
            color: white;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .controlSlider {
            width: 100%;
            margin-bottom: 10px;
        }
        #imagePopupContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 150;
            flex-direction: column;
        }
        #popupImage {
            max-width: 80%;
            max-height: 80%;
            border: 3px solid white;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            object-fit: contain;
        }
        .popupControls {
            display: flex;
            margin-top: 20px;
        }
        .popupButton {
            padding: 10px 20px;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .popupButton:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
        #popupCounter {
            color: white;
            font-size: 16px;
            margin-top: 10px;
            font-family: 'Montserrat', sans-serif;
        }
        #preloadIndicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            z-index: 300;
            display: none;
            text-align: center;
        }
        #preloadSpinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 15px auto;
        }
        .navButton {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 160;
        }
        .navButton:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        #prevButton {
            left: 20px;
        }
        #nextButton {
            right: 20px;
        }
        #imageUploadContainer {
            position: absolute;
            top: 20px;
            left: 200px;
            z-index: 30;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        #imageUploadInput {
            display: none;
        }
        .imageUploadLabel {
            padding: 8px 15px;
            background: linear-gradient(45deg, #ff4e50, #f9d423);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }
        .imageUploadLabel:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
        #imageUploadStatus {
            color: white;
            font-size: 12px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-radius: 5px;
            margin-top: 5px;
            display: none;
        }
        #imageGalleryContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 140;
            overflow-y: auto;
            padding: 50px 0;
        }
        #imageGalleryGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-width: 90%;
            margin: 0 auto;
            padding: 20px;
        }
        .galleryItem {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            overflow: hidden;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .galleryItem:hover {
            transform: scale(1.05);
        }
        .galleryItem img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .galleryControls {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 141;
        }
        #closeGalleryBtn {
            padding: 10px 20px;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        #closeGalleryBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
        #galleryTitle {
            position: fixed;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 24px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            z-index: 141;
        }
        #showGalleryBtn {
            position: absolute;
            top: 20px;
            right: 400px;
            padding: 8px 15px;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 30;
        }
        #showGalleryBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
        #popupElementsContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        .popup-element {
            position: absolute;
            object-fit: contain;
            opacity: 0;
            transition: all 1.5s ease-out;
            transform: translate(-50%, -50%);
        }
        .popup-element.active {
            opacity: 1;
        }
        #liveButton {
            position: absolute;
            bottom: 500px; /* è°ƒæ•´ä½ç½®åœ¨ä¸­é—´åä¸‹ */
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: linear-gradient(45deg, #ff4e50, #f9d423);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 18px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 30;
            display: none; /* é»˜è®¤éšè— */
            text-align: center;
            line-height: 1.5; /* æ§åˆ¶ä¸¤è¡Œæ–‡å­—çš„é—´è· */
        }
        #liveButton:hover {
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div id="container">
        <img id="backgroundImage" alt="èƒŒæ™¯å›¾ç‰‡">
        <div id="popupElementsContainer"></div>
        <div id="threeJsRenderer"></div>
        <div id="textOverlay">
            <div class="title-container">
                <div class="title-background"></div>
                <div class="title">ç¤¾äº¤åª’ä½“æ€ªç‰©</div>
            </div>
            <br>
            <div class="price-container">
                <div class="price-background"></div>
                <div class="price">å”®å–ä»·æ ¼ï¼š25.5BTC</div>
            </div>
        </div>
        <div id="gesturePrompt">
            <span id="gestureIcon">ğŸ™</span>
            åŒæ‰‹åˆåä»¥ç”Ÿæˆä¸“å±æµ·æŠ¥
        </div>
        <div class="watermark">DIGITAL IDENTITY</div>
        <button id="manualCaptureBtn" style="display: none;">ç‚¹å‡»ç”Ÿæˆæµ·æŠ¥</button>
        <div id="backgroundUploadContainer">
            <label for="backgroundUpload" class="uploadLabel">é€‰æ‹©èƒŒæ™¯å›¾ç‰‡</label>
            <input type="file" id="backgroundUpload" accept="image/*">
            <div id="backgroundStatus"></div>
        </div>
        <div id="imageUploadContainer">
            <label for="imageUploadInput" class="imageUploadLabel">ä¸Šä¼ éšæœºå›¾ç‰‡</label>
            <input type="file" id="imageUploadInput" accept="image/*" multiple>
            <div id="imageUploadStatus"></div>
        </div>
        <button id="showGalleryBtn">æŸ¥çœ‹å›¾åº“</button>
        <div id="modelControls">
            <label class="controlLabel">æ¨¡å‹ä½ç½® Z</label>
            <input type="range" id="modelPositionZ" class="controlSlider" min="-5" max="5" step="0.1" value="0">
            <label class="controlLabel">æ¨¡å‹å¤§å°</label>
            <input type="range" id="modelScale" class="controlSlider" min="1" max="10" step="0.5" value="5">
            <label class="controlLabel">æ¨¡å‹äº®åº¦</label>
            <input type="range" id="modelBrightness" class="controlSlider" min="0.1" max="2" step="0.1" value="1">
        </div>
        <button id="liveButton">
            ç‚¹å‡»è¿›å…¥ç›´æ’­é—´<br>åŠ©åŠ›å”®å–
        </button>
    </div>
    <video id="video" autoplay></video>
    <canvas id="canvas"></canvas>
    <div id="debugInfo"></div>
    <div id="posterContainer">
        <img id="posterImage" alt="ç”Ÿæˆçš„æµ·æŠ¥">
        <div>
            <button class="posterButton" id="downloadPoster">ä¸‹è½½æµ·æŠ¥</button>
            <button class="posterButton" id="closePoster">å…³é—­</button>
        </div>
    </div>
    <div id="loadingIndicator">
        <div class="spinner"></div>
        <div class="loadingText">æ­£åœ¨ç”Ÿæˆæµ·æŠ¥...</div>
    </div>
    <div id="imagePopupContainer">
        <img id="popupImage" alt="éšæœºå›¾ç‰‡">
        <div id="popupCounter">å›¾ç‰‡ 1/20</div>
        <div class="popupControls">
            <button class="popupButton" id="closePopupBtn">å…³é—­</button>
        </div>
        <button id="prevButton" class="navButton">â®</button>
        <button id="nextButton" class="navButton">â¯</button>
    </div>
    <div id="preloadIndicator">
        <div id="preloadSpinner"></div>
        <div>æ­£åœ¨åŠ è½½å›¾ç‰‡ï¼Œè¯·ç¨å€™...</div>
    </div>
    <div id="imageGalleryContainer">
        <div id="galleryTitle">å›¾ç‰‡åº“</div>
        <div id="imageGalleryGrid"></div>
        <div class="galleryControls">
            <button id="closeGalleryBtn">å…³é—­å›¾åº“</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134/examples/js/loaders/RGBELoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.4.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        const debugInfo = document.getElementById('debugInfo');
        function log(message) {
            console.log(message);
            debugInfo.innerHTML += message + '<br>';
            if (debugInfo.innerHTML.split('<br>').length > 10) {
                debugInfo.innerHTML = debugInfo.innerHTML.split('<br>').slice(-10).join('<br>');
            }
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const gesturePrompt = document.getElementById('gesturePrompt');
        const posterContainer = document.getElementById('posterContainer');
        const posterImage = document.getElementById('posterImage');
        const downloadPosterBtn = document.getElementById('downloadPoster');
        const closePosterBtn = document.getElementById('closePoster');
        const manualCaptureBtn = document.getElementById('manualCaptureBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const container = document.getElementById('container');
        const backgroundImage = document.getElementById('backgroundImage');
        const backgroundUpload = document.getElementById('backgroundUpload');
        const backgroundStatus = document.getElementById('backgroundStatus');
        const threeJsRenderer = document.getElementById('threeJsRenderer');
        const modelPositionZ = document.getElementById('modelPositionZ');
        const modelScale = document.getElementById('modelScale');
        const modelBrightness = document.getElementById('modelBrightness');
        const imagePopupContainer = document.getElementById('imagePopupContainer');
        const popupImage = document.getElementById('popupImage');
        const popupCounter = document.getElementById('popupCounter');
        const closePopupBtn = document.getElementById('closePopupBtn');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const preloadIndicator = document.getElementById('preloadIndicator');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const imageUploadStatus = document.getElementById('imageUploadStatus');
        const imageGalleryContainer = document.getElementById('imageGalleryContainer');
        const imageGalleryGrid = document.getElementById('imageGalleryGrid');
        const closeGalleryBtn = document.getElementById('closeGalleryBtn');
        const showGalleryBtn = document.getElementById('showGalleryBtn');
        const popupElementsContainer = document.getElementById('popupElementsContainer');

        let randomImages = [];
        let currentImageIndex = 0;
        const numImagesToShow = 20;
        let allUploadedImages = [];
        let customBackgroundLoaded = false;
        let useCustomBackground = false;
        const popupImages = [];
        let popupElements = [];

        function preloadPopupImages() {
    const basePath = './elements/';
    const totalImages = 97; // æ€»å›¾ç‰‡æ•°é‡ï¼Œä» 1 åˆ° 97
    const numToShow = 20;  // è¦éšæœºå±•ç¤ºçš„å›¾ç‰‡æ•°é‡
    const allImageIndices = Array.from({ length: totalImages }, (_, i) => i + 1); // 1 åˆ° 97 çš„ç´¢å¼•æ•°ç»„

    for (let i = 0; i < numToShow && allImageIndices.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * allImageIndices.length);
        const selectedIndex = allImageIndices[randomIndex];
        const imgPath = `${basePath}5 (${selectedIndex}).png`;
        const img = new Image();
        img.src = imgPath;
        popupImages.push(img);
        allImageIndices.splice(randomIndex, 1);
    }
}

        function createPopupElements() {
            popupImages.forEach((img, index) => {
                const element = document.createElement('img');
                element.src = img.src;
                element.className = 'popup-element';
                element.style.left = '50%';
                element.style.top = '50%';
                const randomSize = (50 + Math.random() * 100) * 3 * 0.8; // è°ƒå¤§3å€åç¼©æ”¾0.8å€
                element.style.width = `${randomSize}px`;
                element.style.height = `${randomSize}px`;
                popupElementsContainer.appendChild(element);
                popupElements.push(element);
            });
        }

        function triggerPopupAnimation() {
            popupElements.forEach((element, index) => {
                setTimeout(() => {
                    element.classList.add('active');
                    const angle = Math.random() * 2 * Math.PI;
                    const distanceX = 100 + Math.random() * 1000; // å·¦å³åˆ†æ•£èŒƒå›´
                    const distanceY = 100 + Math.random() * 1800; // ä¸Šä¸‹åˆ†æ•£èŒƒå›´æ›´å¤¸å¼ 
                    const xOffset = Math.cos(angle) * distanceX;
                    const yOffset = Math.sin(angle) * distanceY * (Math.random() < 0.5 ? -1 : 1); // ä¸Šä¸‹éšæœºæ­£è´Ÿ
                    element.style.transform = `translate(${xOffset - 50}px, ${yOffset - 50}px) scale(${1 + Math.random() * 0.5})`;
                    element.style.opacity = '1';
                }, index * 150);
            });
        }

        function loadDefaultBackground() {
            const defaultBackgroundUrl = 'background.png';
            try {
                backgroundImage.onload = function() {
                    log("é»˜è®¤èƒŒæ™¯å›¾ç‰‡åŠ è½½æˆåŠŸï¼");
                    backgroundImage.style.opacity = '1';
                    customBackgroundLoaded = true;
                    useCustomBackground = true;
                };
                backgroundImage.onerror = function() {
                    log("é»˜è®¤èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨çº¯è‰²èƒŒæ™¯");
                    useCustomBackground = false;
                    container.style.backgroundColor = "#000000";
                };
                backgroundImage.src = defaultBackgroundUrl;
            } catch (error) {
                log("åŠ è½½é»˜è®¤èƒŒæ™¯å›¾ç‰‡å‡ºé”™: " + error);
                useCustomBackground = false;
                container.style.backgroundColor = "#000000";
            }
        }

        backgroundUpload.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                if (!file.type.match('image.*')) {
                    backgroundStatus.textContent = "è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶";
                    backgroundStatus.style.display = 'block';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    backgroundImage.onload = function() {
                        log("è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡åŠ è½½æˆåŠŸï¼");
                        backgroundImage.style.opacity = '1';
                        customBackgroundLoaded = true;
                        useCustomBackground = true;
                        backgroundStatus.textContent = "èƒŒæ™¯å›¾ç‰‡å·²è®¾ç½®";
                        backgroundStatus.style.display = 'block';
                    };
                    backgroundImage.src = event.target.result;
                };
                reader.onerror = function() {
                    log("è¯»å–èƒŒæ™¯å›¾ç‰‡æ–‡ä»¶å¤±è´¥");
                    backgroundStatus.textContent = "è¯»å–å›¾ç‰‡å¤±è´¥";
                    backgroundStatus.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        imageUploadInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files.length > 0) {
                const files = Array.from(e.target.files);
                const invalidFiles = files.filter(file => !file.type.match('image.*'));
                if (invalidFiles.length > 0) {
                    imageUploadStatus.textContent = "è¯·åªé€‰æ‹©å›¾ç‰‡æ–‡ä»¶";
                    imageUploadStatus.style.display = 'block';
                    return;
                }
                preloadIndicator.style.display = 'block';
                imageUploadStatus.textContent = `æ­£åœ¨åŠ è½½ ${files.length} å¼ å›¾ç‰‡...`;
                imageUploadStatus.style.display = 'block';
                randomImages = [];
                let loadedCount = 0;
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = function() {
                            allUploadedImages.push({
                                path: event.target.result,
                                element: img,
                                name: file.name
                            });
                            if (files.length <= numImagesToShow) {
                                randomImages.push({
                                    path: event.target.result,
                                    element: img,
                                    name: file.name
                                });
                            }
                            loadedCount++;
                            if (loadedCount === files.length) {
                                if (files.length > numImagesToShow && randomImages.length === 0) {
                                    const indices = Array.from({ length: allUploadedImages.length }, (_, i) => i);
                                    for (let i = 0; i < numImagesToShow && indices.length > 0; i++) {
                                        const randomIndex = Math.floor(Math.random() * indices.length);
                                        randomImages.push(allUploadedImages[indices[randomIndex]]);
                                        indices.splice(randomIndex, 1);
                                    }
                                }
                                preloadIndicator.style.display = 'none';
                                updateImageGallery();
                                if (randomImages.length > 0) {
                                    imageUploadStatus.textContent = `å·²åŠ è½½ ${files.length} å¼ å›¾ç‰‡ï¼Œéšæœºé€‰æ‹© ${randomImages.length} å¼ æ˜¾ç¤º`;
                                    showRandomImagePopup();
                                } else {
                                    imageUploadStatus.textContent = "æ²¡æœ‰å¯ç”¨çš„å›¾ç‰‡";
                                }
                            }
                        };
                        img.onerror = function() {
                            log(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${file.name}`);
                            loadedCount++;
                            if (loadedCount === files.length) {
                                preloadIndicator.style.display = 'none';
                                updateImageGallery();
                                if (randomImages.length > 0) {
                                    imageUploadStatus.textContent = `å·²åŠ è½½ ${loadedCount} å¼ å›¾ç‰‡ï¼Œæœ‰äº›å›¾ç‰‡åŠ è½½å¤±è´¥`;
                                    showRandomImagePopup();
                                } else {
                                    imageUploadStatus.textContent = "æ²¡æœ‰å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œæ— æ³•æ˜¾ç¤ºå¼¹çª—";
                                }
                            }
                        };
                        img.src = event.target.result;
                    };
                    reader.onerror = function() {
                        log(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${file.name}`);
                        loadedCount++;
                        if (loadedCount === files.length) {
                            preloadIndicator.style.display = 'none';
                            updateImageGallery();
                            if (randomImages.length > 0) {
                                imageUploadStatus.textContent = `å·²åŠ è½½ ${loadedCount} å¼ å›¾ç‰‡ï¼Œæœ‰äº›å›¾ç‰‡è¯»å–å¤±è´¥`;
                                showRandomImagePopup();
                            } else {
                                imageUploadStatus.textContent = "æ²¡æœ‰å›¾ç‰‡è¯»å–æˆåŠŸï¼Œæ— æ³•æ˜¾ç¤ºå¼¹çª—";
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        function updateImageGallery() {
            imageGalleryGrid.innerHTML = '';
            allUploadedImages.forEach((image, index) => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'galleryItem';
                const img = document.createElement('img');
                img.src = image.path;
                img.alt = image.name || `å›¾ç‰‡ ${index + 1}`;
                galleryItem.appendChild(img);
                galleryItem.addEventListener('click', function() {
                    const popupIndex = randomImages.findIndex(img => img.path === image.path);
                    if (popupIndex !== -1) {
                        currentImageIndex = popupIndex;
                        updatePopupImage();
                        imageGalleryContainer.style.display = 'none';
                        imagePopupContainer.style.display = 'flex';
                    } else {
                        randomImages.push(image);
                        currentImageIndex = randomImages.length - 1;
                        updatePopupImage();
                        imageGalleryContainer.style.display = 'none';
                        imagePopupContainer.style.display = 'flex';
                    }
                });
                imageGalleryGrid.appendChild(galleryItem);
            });
        }

        showGalleryBtn.addEventListener('click', function() {
            if (allUploadedImages.length === 0) {
                alert('å›¾åº“ä¸ºç©ºï¼Œè¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }
            imageGalleryContainer.style.display = 'block';
        });

        closeGalleryBtn.addEventListener('click', function() {
            imageGalleryContainer.style.display = 'none';
        });

        function showRandomImagePopup() {
            if (randomImages.length === 0) {
                log("æ²¡æœ‰å¯ç”¨çš„å›¾ç‰‡");
                return;
            }
            currentImageIndex = 0;
            updatePopupImage();
            imagePopupContainer.style.display = 'flex';
        }

        function updatePopupImage() {
            if (randomImages.length === 0) return;
            const currentImage = randomImages[currentImageIndex];
            popupImage.src = currentImage.path;
            popupCounter.textContent = `å›¾ç‰‡ ${currentImageIndex + 1}/${randomImages.length}`;
        }

        function showNextImage() {
            if (randomImages.length === 0) return;
            currentImageIndex = (currentImageIndex + 1) % randomImages.length;
            updatePopupImage();
        }

        function showPrevImage() {
            if (randomImages.length === 0) return;
            currentImageIndex = (currentImageIndex - 1 + randomImages.length) % randomImages.length;
            updatePopupImage();
        }

        closePopupBtn.addEventListener('click', function() {
            imagePopupContainer.style.display = 'none';
        });

        prevButton.addEventListener('click', showPrevImage);
        nextButton.addEventListener('click', showNextImage);

        document.addEventListener('keydown', function(event) {
            if (imagePopupContainer.style.display === 'flex') {
                if (event.key === 'ArrowLeft') {
                    showPrevImage();
                } else if (event.key === 'ArrowRight') {
                    showNextImage();
                } else if (event.key === 'Escape') {
                    imagePopupContainer.style.display = 'none';
                }
            } else if (imageGalleryContainer.style.display === 'block') {
                if (event.key === 'Escape') {
                    imageGalleryContainer.style.display = 'none';
                }
            }
        });

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 1080 / 1920, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true, alpha: true });
        renderer.setSize(1080, 1920);
        renderer.physicallyCorrectLights = true;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        renderer.setClearColor(0x000000, 0);
        threeJsRenderer.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
        directionalLight.position.set(0, 1, 0).normalize();
        scene.add(directionalLight);
        const frontLight = new THREE.DirectionalLight(0xffffff, 1.0);
        frontLight.position.set(0, 0, 5).normalize();
        scene.add(frontLight);
        const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
        backLight.position.set(0, 0, -5).normalize();
        scene.add(backLight);

        const rgbeLoader = new THREE.RGBELoader();
        rgbeLoader.load('studio_small_09_2k.hdr', (texture) => {
            texture.mapping = THREE.EquirectangularReflectionMapping;
            scene.environment = texture;
            log("HDR ç¯å¢ƒè´´å›¾åŠ è½½æˆåŠŸï¼");
        }, undefined, (error) => {
            log('åŠ è½½ HDR å‡ºé”™:' + error);
        });

        loadDefaultBackground();

        const models = [
            { path: './venus1.gltf', title: "ç¤¾äº¤åª’ä½“æ€ªç‰©", price: "å”®å–ä»·æ ¼ï¼š25.5BTC" },
            { path: './venus2.gltf', title: "æ•°å­—å¥´éš¶", price: "å”®å–ä»·æ ¼ï¼š39.15ETH" },
            { path: './venus3.gltf', title: "è™šæ‹Ÿè‡ªæˆ‘å¤§å¸ˆ", price: "å”®å–ä»·æ ¼ï¼š51.88XRP" },
            { path: './venus4.gltf', title: "æƒ…æ„Ÿæ¶ˆè´¹æœºå™¨", price: "å”®å–ä»·æ ¼ï¼š88.55LTC" }
        ];

        const randomModel = models[Math.floor(Math.random() * models.length)];
        const titleElement = document.querySelector('.title');
        const priceElement = document.querySelector('.price');
        titleElement.textContent = randomModel.title;
        priceElement.textContent = randomModel.price;

        let model;
        const loader = new THREE.GLTFLoader();
        loader.load(randomModel.path, (gltf) => {
            model = gltf.scene;
            scene.add(model);
            log("æ¨¡å‹åŠ è½½æˆåŠŸï¼");
            model.position.set(0, 0, 0);
            if (randomModel.path === './venus1.gltf') {
                model.scale.set(2, 2, 2);
            } else {
                model.scale.set(5, 5, 5);
            }
            model.traverse((child) => {
                if (child.isMesh) {
                    child.material = new THREE.MeshStandardMaterial({
                        map: null,
                        metalness: 0.3,
                        roughness: 0.7,
                        emissive: new THREE.Color(0x111111),
                        emissiveIntensity: 0.1
                    });
                }
            });
            camera.position.set(0, 1, 2);
            startRotation();
        }, undefined, (error) => {
            log('æ¨¡å‹åŠ è½½å¤±è´¥:' + error);
        });

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        const keys = {};
        document.addEventListener('keydown', (event) => {
            keys[event.key] = true;
        });
        document.addEventListener('keyup', (event) => {
            keys[event.key] = false;
        });

        let rotationAngle = 0;
        const rotationSpeed = 0.01;
        const targetAngle = 2 * Math.PI;

        function startRotation() {
            rotationAngle = 0;
            triggerPopupAnimation();
        }

        modelPositionZ.addEventListener('input', function() {
            if (model) {
                model.position.z = parseFloat(this.value);
            }
        });
        modelScale.addEventListener('input', function() {
            if (model) {
                const scale = parseFloat(this.value);
                model.scale.set(scale, scale, scale);
            }
        });
        modelBrightness.addEventListener('input', function() {
            const brightness = parseFloat(this.value);
            ambientLight.intensity = brightness * 1.5;
            directionalLight.intensity = brightness;
            frontLight.intensity = brightness;
        });

        function animate() {
            requestAnimationFrame(animate);
            if (model) {
                const speed = 0.1;
                if (keys['w']) model.position.z -= speed;
                if (keys['s']) model.position.z += speed;
                if (keys['a']) model.position.x -= speed;
                if (keys['d']) model.position.x += speed;
                model.rotation.y += rotationSpeed;
                rotationAngle += rotationSpeed;
            }
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        function applyTexture() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(0, canvas.height);
            ctx.scale(1, -1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.setTransform(1, 0, 0, 1, 0, 0);

            const texture = new THREE.CanvasTexture(canvas);
            texture.needsUpdate = true;
            if (model) {
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.material.map = texture;
                        child.material.needsUpdate = true;
                    }
                });
            }
            log("çº¹ç†å·²åº”ç”¨ï¼");
            gesturePrompt.style.display = 'block';
            setTimeout(() => {
                manualCaptureBtn.style.display = 'block';
            }, 5000);
            startHandDetection();
        }

        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        log("æ‘„åƒå¤´åŠ è½½æˆåŠŸï¼");
                        video.play();
                        loadHandposeModel();
                        setTimeout(() => {
                            applyTexture();
                        }, 2000);
                    };
                })
                .catch(err => {
                    log("æ— æ³•è®¿é—®æ‘„åƒå¤´:" + err);
                    alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–è®¾å¤‡ï¼");
                    manualCaptureBtn.style.display = 'block';
                });
        }

        startVideo();

        let handposeModel;
        let handDetectionActive = false;
        let prayerHandsDetected = false;
        let prayerHandsStartTime = 0;
        const prayerHandsDuration = 1000;

        async function loadHandposeModel() {
            try {
                handposeModel = await handpose.load();
                log("Handpose æ¨¡å‹åŠ è½½æˆåŠŸï¼");
            } catch (error) {
                log("Handpose æ¨¡å‹åŠ è½½å¤±è´¥:" + error);
                manualCaptureBtn.style.display = 'block';
            }
        }

        function startHandDetection() {
            if (handDetectionActive) return;
            handDetectionActive = true;
            detectHands();
        }

        async function detectHands() {
            if (!handDetectionActive || !handposeModel) {
                return;
            }
            try {
                const hands = await handposeModel.estimateHands(video);
                if (hands.length === 2) {
                    log("æ£€æµ‹åˆ°ä¸¤åªæ‰‹");
                    const hand1 = hands[0].landmarks;
                    const hand2 = hands[1].landmarks;
                    const hand1Center = calculateHandCenter(hand1);
                    const hand2Center = calculateHandCenter(hand2);
                    const distance = calculateDistance(hand1Center, hand2Center);
                    if (distance < 100) {
                        log("æ£€æµ‹åˆ°åŒæ‰‹åˆåå§¿åŠ¿ï¼Œè·ç¦»: " + distance.toFixed(2));
                        if (!prayerHandsDetected) {
                            prayerHandsDetected = true;
                            prayerHandsStartTime = Date.now();
                            log("æ£€æµ‹åˆ°åŒæ‰‹åˆåå§¿åŠ¿ï¼Œè¯·ä¿æŒ...");
                        } else {
                            const elapsedTime = Date.now() - prayerHandsStartTime;
                            if (elapsedTime >= prayerHandsDuration) {
                                log("åŒæ‰‹åˆåå§¿åŠ¿å·²ä¿æŒè¶³å¤Ÿæ—¶é—´ï¼Œç”Ÿæˆæµ·æŠ¥...");
                                handDetectionActive = false;
                                gesturePrompt.style.display = 'none';
                                createPoster();
                                return;
                            }
                        }
                    } else {
                        if (prayerHandsDetected) {
                            prayerHandsDetected = false;
                            log("åŒæ‰‹åˆåå§¿åŠ¿å·²ä¸­æ–­ï¼Œè¯·é‡æ–°å°è¯•");
                        }
                    }
                } else if (hands.length === 1) {
                    log("åªæ£€æµ‹åˆ°ä¸€åªæ‰‹ï¼Œè¯·ç¡®ä¿ä¸¤åªæ‰‹éƒ½åœ¨ç”»é¢ä¸­");
                    if (prayerHandsDetected) {
                        prayerHandsDetected = false;
                    }
                } else {
                    if (prayerHandsDetected) {
                        prayerHandsDetected = false;
                        log("æœªæ£€æµ‹åˆ°æ‰‹ï¼Œè¯·ç¡®ä¿æ‰‹åœ¨ç”»é¢ä¸­");
                    }
                }
                requestAnimationFrame(detectHands);
            } catch (error) {
                log("æ‰‹åŠ¿æ£€æµ‹é”™è¯¯:" + error);
                requestAnimationFrame(detectHands);
            }
        }

        function calculateHandCenter(landmarks) {
            let sumX = 0;
            let sumY = 0;
            for (const point of landmarks) {
                sumX += point[0];
                sumY += point[1];
            }
            return {
                x: sumX / landmarks.length,
                y: sumY / landmarks.length
            };
        }

        function calculateDistance(point1, point2) {
            return Math.sqrt(
                Math.pow(point1.x - point2.x, 2) + 
                Math.pow(point1.y - point2.y, 2)
            );
        }

        function createPoster() {
            log("æ­£åœ¨ç”Ÿæˆæµ·æŠ¥...");
            loadingIndicator.style.display = 'flex';
            video.style.display = 'none';
            debugInfo.style.display = 'none';
            manualCaptureBtn.style.display = 'none';
            document.getElementById('backgroundUploadContainer').style.display = 'none';
            document.getElementById('imageUploadContainer').style.display = 'none';
            document.getElementById('showGalleryBtn').style.display = 'none';
            document.getElementById('modelControls').style.display = 'none';
            if (useCustomBackground && customBackgroundLoaded) {
                backgroundImage.style.opacity = '1';
            }
            setTimeout(() => {
                html2canvas(container, {
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    scale: 1,
                    logging: true,
                    onclone: function(clonedDoc) {
                        log("html2canvasæ­£åœ¨å…‹éš†æ–‡æ¡£...");
                    }
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    posterImage.src = imgData;
                    posterContainer.style.display = 'flex';
                    video.style.display = 'block';
                    debugInfo.style.display = 'block';
                    document.getElementById('backgroundUploadContainer').style.display = 'flex';
                    document.getElementById('imageUploadContainer').style.display = 'flex';
                    document.getElementById('showGalleryBtn').style.display = 'block';
                    document.getElementById('modelControls').style.display = 'flex';
                    loadingIndicator.style.display = 'none';
                    log("æµ·æŠ¥ç”Ÿæˆå®Œæˆï¼");
                }).catch(error => {
                    log("ç”Ÿæˆæµ·æŠ¥å‡ºé”™:" + error);
                    try {
                        const captureCanvas = document.createElement('canvas');
                        captureCanvas.width = container.offsetWidth;
                        captureCanvas.height = container.offsetHeight;
                        const ctx = captureCanvas.getContext('2d');
                        if (useCustomBackground && customBackgroundLoaded) {
                            ctx.drawImage(backgroundImage, 0, 0, captureCanvas.width, captureCanvas.height);
                        } else {
                            ctx.fillStyle = '#000000';
                            ctx.fillRect(0, 0, captureCanvas.width, captureCanvas.height);
                        }
                        ctx.drawImage(renderer.domElement, 0, 0);
                        ctx.save();
                        ctx.translate(captureCanvas.width / 2, captureCanvas.height - 250);
                        ctx.rotate(-5 * Math.PI / 180);
                        const titleGradient = ctx.createLinearGradient(-200, 0, 200, 0);
                        titleGradient.addColorStop(0, '#FF6B6B');
                        titleGradient.addColorStop(1, '#FF8E53');
                        ctx.fillStyle = titleGradient;
                        ctx.fillRect(-250, -40, 500, 80);
                        ctx.restore();
                        ctx.font = 'bold 56px Montserrat';
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.fillText(titleElement.textContent, captureCanvas.width / 2, captureCanvas.height - 250);
                        ctx.save();
                        ctx.translate(captureCanvas.width / 2, captureCanvas.height - 150);
                        ctx.rotate(-5 * Math.PI / 180);
                        const priceGradient = ctx.createLinearGradient(-150, 0, 150, 0);
                        priceGradient.addColorStop(0, '#4A00E0');
                        priceGradient.addColorStop(1, '#8E2DE2');
                        ctx.fillStyle = priceGradient;
                        ctx.fillRect(-200, -30, 400, 60);
                        ctx.restore();
                        ctx.font = '600 36px Montserrat';
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.fillText(priceElement.textContent, captureCanvas.width / 2, captureCanvas.height - 150);
                        ctx.font = '16px Montserrat';
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                        ctx.textAlign = 'right';
                        ctx.fillText('DIGITAL IDENTITY', captureCanvas.width - 30, captureCanvas.height - 30);
                        const imgData = captureCanvas.toDataURL('image/png');
                        posterImage.src = imgData;
                        posterContainer.style.display = 'flex';
                        log("ä½¿ç”¨å¤‡é€‰æ–¹æ³•ç”Ÿæˆæµ·æŠ¥æˆåŠŸï¼");
                    } catch (backupError) {
                        log("å¤‡é€‰æ–¹æ³•ä¹Ÿå¤±è´¥:" + backupError);
                    }
                    video.style.display = 'block';
                    debugInfo.style.display = 'block';
                    manualCaptureBtn.style.display = 'block';
                    document.getElementById('backgroundUploadContainer').style.display = 'flex';
                    document.getElementById('imageUploadContainer').style.display = 'flex';
                    document.getElementById('showGalleryBtn').style.display = 'block';
                    document.getElementById('modelControls').style.display = 'flex';
                    loadingIndicator.style.display = 'none';
                });
            }, 100);
        }

        manualCaptureBtn.addEventListener('click', () => {
            handDetectionActive = false;
            gesturePrompt.style.display = 'none';
            createPoster();
        });

        downloadPosterBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'æˆ‘çš„äººæ ¼æµ·æŠ¥.png';
            link.href = posterImage.src;
            link.click();
        });

        closePosterBtn.addEventListener('click', () => {
            posterContainer.style.display = 'none';
            prayerHandsDetected = false;
            handDetectionActive = true;
            gesturePrompt.style.display = 'block';
            manualCaptureBtn.style.display = 'block';
            detectHands();
        });

        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space' && gesturePrompt.style.display === 'block') {
                handDetectionActive = false;
                gesturePrompt.style.display = 'none';
                createPoster();
            }
        });

        window.addEventListener('error', (event) => {
            log("å‘ç”Ÿé”™è¯¯: " + event.message);
            manualCaptureBtn.style.display = 'block';
        });

        document.addEventListener('DOMContentLoaded', () => {
            preloadPopupImages();
            createPopupElements();
            const liveButton = document.getElementById('liveButton');
            setTimeout(() => {
                liveButton.style.display = 'block';
            }, 5000); // 5ç§’åæ˜¾ç¤º
            liveButton.addEventListener('click', () => {
                window.location.href = 'step4.html'; // ä¿®æ”¹ä¸ºè·³è½¬åˆ° step4.html
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'92d3e6da6e368978',t:'MTc0NDEzNzcxNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'92d3fd697b1c747a',t:'MTc0NDEzODY0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>